<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Scanner</title>
    <script src="https://cdn.jsdelivr.net/npm/dynamsoft-javascript-barcode@9.6.30/dist/dbr.js"></script>
    <style>
        /* Keeping the same styles for brevity */
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, system-ui, sans-serif;
            background: #f5f5f7;
            max-width: 800px;
            margin: 0 auto;
        }
        .status-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 10px;
            background: #FF3B30;
            color: white;
            text-align: center;
            z-index: 1000;
            display: none;
        }
        .button-container {
            display: flex;
            gap: 15px;
            margin: 20px 0;
        }
        button {
            flex: 1;
            padding: 16px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
        }
        .scan-item {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div id="statusBanner" class="status-banner"></div>
    <h1>Product Scanner</h1>
    
    <div class="button-container">
        <button onclick="initializeScanner('upload')" id="uploadBtn">Upload Image</button>
        <button onclick="initializeScanner('camera')" id="cameraBtn">Take Picture</button>
    </div>

    <div id="scanHistory"></div>

    <script>
        let reader = null;
        let scans = [];
        let isInitializing = false;
        const LICENSE_KEY = 'DLS2eyJoYW5kc2hha2VDb2RlIjoiMjAwMDAxLTE2NDk4Mjk3OTI2MzUiLCJvcmdhbml6YXRpb25JRCI6IjIwMDAwMSIsInNlc3Npb25QYXNzd29yZCI6IndTcGR6Vm05WDJrcEQ5YUoifQ==';

        function showStatus(message, isError = false) {
            const banner = document.getElementById('statusBanner');
            banner.style.background = isError ? '#FF3B30' : '#34C759';
            banner.textContent = message;
            banner.style.display = 'block';
            setTimeout(() => banner.style.display = 'none', 3000);
        }

        async function initBarcodeReader() {
            if (isInitializing) return false;
            if (reader) return true;

            isInitializing = true;
            try {
                Dynamsoft.DBR.BarcodeReader.license = LICENSE_KEY;
                reader = await Dynamsoft.DBR.BarcodeReader.createInstance();
                return true;
            } catch (error) {
                console.error('Scanner initialization error:', error);
                showStatus('Scanner error: ' + error.message, true);
                return false;
            } finally {
                isInitializing = false;
            }
        }

        function disableButtons(disable) {
            document.getElementById('uploadBtn').disabled = disable;
            document.getElementById('cameraBtn').disabled = disable;
        }

        async function initializeScanner(mode) {
            disableButtons(true);
            
            if (!await initBarcodeReader()) {
                disableButtons(false);
                return;
            }

            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            if (mode === 'camera') input.capture = 'environment';
            input.multiple = true;
            input.onchange = handleFiles;
            input.click();
            
            disableButtons(false);
        }

        async function handleFiles(event) {
            const files = event.target.files;
            if (!files.length) return;

            disableButtons(true);
            showStatus('Processing...');

            try {
                for (const file of files) {
                    try {
                        const results = await reader.decode(file);
                        
                        if (results.length > 0) {
                            const barcode = results[0].barcodeText;
                            
                            if (!scans.find(scan => scan.barcode === barcode)) {
                                const scan = {
                                    barcode,
                                    timestamp: new Date().toLocaleString()
                                };
                                
                                scans.unshift(scan);
                                updateHistory();
                                showStatus(`Scanned: ${barcode}`);
                                if (navigator.vibrate) navigator.vibrate(200);
                            } else {
                                showStatus('Duplicate barcode', true);
                            }
                        } else {
                            showStatus('No barcode found', true);
                        }
                    } catch (error) {
                        showStatus('Error processing image: ' + error.message, true);
                    }
                }
            } finally {
                disableButtons(false);
            }
        }

        function updateHistory() {
            const history = document.getElementById('scanHistory');
            if (scans.length === 0) {
                history.innerHTML = '';
                return;
            }

            history.innerHTML = scans.map(scan => `
                <div class="scan-item">
                    <div><strong>Barcode:</strong> ${scan.barcode}</div>
                    <div><small>${scan.timestamp}</small></div>
                </div>
            `).join('');
        }

        // Initialize on page load
        window.onload = initBarcodeReader;
    </script>
</body>
</html>
